# これは何?

「MFCFriendlyDriverGenerator」はRCファイル(Win32・MFC)から[Friendly](https://github.com/Codeer-Software/Friendly)用のドライバクラスクラスを生成するライブラリです。

# 仕組みと設定

以下に示す方法でドライバクラスを生成します。

![concept.drawio](img/concept.drawio.svg)

まず、設定ファイルで

- 解析するRCファイル(target.rc)と
- 出力するドライバクラスの名前空間(例: MFCDriver)
- プロジェクトのルートパス(設定ファイルのディレクトリから相対パス)

を指定します。

設定ファイルは以下の名前で以下の様に記述します。
mfc_friendly_gen.xml (setting/mfc_friendly_gen.xmlに入れた場合)
~~~ xml
<?xml version="1.0" encoding="UTF-8" ?>
<FriendlyDriverGenerator>
  <MFCFriendly nameSpace="MFCDriver" projectDir="..\" rcFilePath="target.rc">
  </MFCFriendly>
</FriendlyDriverGenerator>
~~~
また、このファイルはcsprojにて設定ファイルを登録する必要がります。
``` xml
<AdditionalFiles Include="setting\*.xml" />
```

ドライバ生成するために

- コントロールID (例; #define IDC_COMBOBOX 20)と
- コントロールの種類 (例: COMBOBOX     IDC_COMBOBOX,85,49,136,30,CBS_DROPDOWNLIST | CBS_AUTOHSCROLL | WS_VSCROLL | WS_TABSTOP)と
- そのコントロールが配置されているダイアログの名前 (例: IDD MAIN)

を取得する必要があるので

図中の1や2で「RCファイル」と「RCファイルで#includeしているプロジェクト内の全ファイル」(例:resource.h)をパースします。

COMBOBOXのドライバは、

「Codeer.Friendly.Windows.NativeStandardControls.NativeComboBox」の型と対応しているので

「COMBOBOX」という名前で上記の文字列を辞書(MFCFriendlyDriverTable)から取り出します。

最終的に以下のような内容のファイルを出力します。

~~~ csharp
using System.CodeDom.Compiler;
using Codeer.Friendly.Windows.Grasp;

namespace MFCDriver {

    // <auto-generated>
    // THIS (.cs) FILE IS GENERATED BY T4. DO NOT CHANGE IT.
    // </auto-generated>
    [GeneratedCode("MFCFriendlyDriverGenerator", "0.8.22")]
    public static class IDD_MAINKeys {
        public static int IDC_COMBOBOX => 20;
    }

    // <auto-generated>
    // THIS (.cs) FILE IS GENERATED BY T4. DO NOT CHANGE IT.
    // </auto-generated>
    [GeneratedCode("MFCFriendlyDriverGenerator", "0.8.22")]
    public partial class IDD_MAINDriver {
        public WindowControl Dialog { get; }

        public Codeer.Friendly.Windows.NativeStandardControls.NativeComboBox IDC_COMBOBOX => new Codeer.Friendly.Windows.NativeStandardControls.NativeComboBox(Dialog.IdentifyFromDialogId(IDD_MAINKeys.IDC_COMBOBOX));

        public IDD_MAINDriver(WindowControl dialog) {
            Dialog = dialog;
        }
    }
}
~~~


# 設定
このプログラムは、RCファイルに含まれる#includeを解析するため、インクルードパスを設定する必要があります。
インクルードパスはmsvc(cl.exe)の環境変数に対して行います。
環境変数 INCLUDE に以下のようなパスを指定する必要があります。	
ただし、このパスはVisual Studioのインストール環境によって異なりますので、あくまで例です。

~~~ 
C:\Program Files (x86)\Windows Kits\10\Include\10.0.16299.0\um;C:\Program Files (x86)\Windows Kits\10\Include\10.0.16299.0\shared;C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.29.30133\atlmfc\include;
~~~
